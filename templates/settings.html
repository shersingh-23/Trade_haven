{% extends 'base.html' %}
{% block title %}Settings | TradeHaven{% endblock %}

{% block content %}
<div class="flex min-h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-64 h-[calc(100vh-5rem)] shadow-2xl flex flex-col justify-between py-6 px-4 fixed top-20 left-0">
    <div>
      <div class="text-center mb-6">
        <div class="text-[#FFA500] font-bold text-xl uppercase">{{ user.name }}</div>
        <div class="mt-3 mb-2 rounded-lg border border-[#FFA500] py-2 px-4 flex items-center justify-center">
          <h6>WALLET :</h6>
          <span class="text-lg font-semibold text-green-400 ps-2"> ₹ {{ '%.2f' | format(user.balance) }}</span>
        </div>
      </div>
      <nav class="space-y-9 text-sm">
        <a href="/dashboard" class="block hover:text-[#FFA500] mt-[50px] text-center">Dashboard</a>
        <a href="/watchlist" class="block hover:text-[#FFA500] text-center">WatchList</a>
        <a href="/portfolio" class="block hover:text-[#FFA500] text-center">Portfolio</a>
        <a href="/market" class="block hover:text-[#FFA500] text-center">Market</a>
        <a href="/prediction" class="block hover:text-[#FFA500] text-center">Prediction</a>
        <a href="/transactions" class="block hover:text-[#FFA500] text-center">Transaction</a>
        <a href="/support" class="block hover:text-[#FFA500] text-center">Support</a>
        <a href="/settings" class="block font-bold text-[#FFA500] text-center">Setting</a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 ms-[200px]">
    <div class="p-6 rounded-lg shadow-2xl max-w-xl mx-auto text-center">
      <h2 class="text-2xl font-bold text-yellow-400 mb-6">Change Password</h2>

      <!-- Profile Image -->
      <div class="flex justify-center mb-6">
        <img src="{{ url_for('static', filename='images/default-profile.png') }}" alt="Profile"
             class="w-24 h-24 rounded-full border-4 border-yellow-400">
      </div>

      <!-- Password Update Form -->
      <form id="passwordForm" action="/settings" method="POST" class="space-y-4 text-left" onsubmit="return validatePasswordForm()">
        <label class="block text-sm">Current Password</label>
        <input type="password" name="current_password" placeholder="Enter current password"
               class="w-full rounded px-4 py-2 text-black" required>

        <label class="block text-sm">New Password</label>
        <input type="password" id="new_password" name="new_password" placeholder="Enter new password"
               class="w-full rounded px-4 py-2 text-black" required>

        <label class="block text-sm">Confirm New Password</label>
        <input type="password" id="confirm_password" name="confirm_password" placeholder="Re-enter new password"
               class="w-full rounded px-4 py-2 text-black" required>

        <button type="submit" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 rounded-md">
          Update Password
        </button>
      </form>

      {% if message %}
      <div class="mt-4 text-sm text-center {% if '✅' in message %}text-green-400{% else %}text-red-400{% endif %}">
        {{ message }}
      </div>
      {% endif %}

      <!-- Logout Button -->
      <form action="/logout" method="GET">
        <button type="submit"
                class="w-full mt-6 bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 rounded-md">
          Log Out
        </button>
      </form>
    </div>
  </main>
</div>

<!-- Password Validation Script -->
<script>
  function validatePasswordForm() {
    const pw = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;

    const strongPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

    if (!strongPattern.test(pw)) {
      alert("❌ Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.");
      return false;
    }

    if (pw !== confirm) {
      alert("❌ New password and confirmation do not match.");
      return false;
    }

    return true; // Allow submission
  }
</script>
{% endblock %}
