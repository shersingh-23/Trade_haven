{% extends 'base.html' %}
{% block title %}Portfolio | TradeHaven{% endblock %}

{% block content %}
<!-- Push content below fixed navbar -->
<div class="pt-24 flex min-h-screen overflow-hidden">

  <!-- Fixed Sidebar -->
  <aside class="w-64 h-[calc(100vh-5rem)] overflow-y-auto shadow-2xl flex flex-col justify-between py-6 px-4 fixed top-20 left-0">
    <div>
      <div class="text-center mb-6">
        <div class="text-[#FFA500] uppercase font-bold text-xl">{{ user.name }}</div>
        <div class="mt-3 mb-2 rounded-lg border border-[#FFA500] py-2 px-4 flex items-center justify-center">
          <h6>WALLET : </h6>
          <span class="text-lg font-semibold text-green-400 ps-2"> ₹ {{ '%.2f' | format(user.balance) }}</span>
        </div>
      </div>
      <nav class="space-y-9 text-sm">
        <a href="/dashboard" class="block hover:text-[#FFA500] mt-[50px] text-center">Dashboard</a>
        <a href="/watchlist" class="block hover:text-[#FFA500] text-center">WatchList</a>
        <a href="/portfolio" class="block font-bold text-[#FFA500] text-center">Portfolio</a>
        <a href="/market" class="block hover:text-[#FFA500] text-center">Market</a>
        <a href="/prediction" class="block hover:text-[#FFA500] text-center">Prediction</a>
        <a href="/transactions" class="block hover:text-[#FFA500] text-center">Transaction</a>
        <a href="/support" class="block hover:text-[#FFA500] text-center">Support</a>
        <a href="/settings" class="block hover:text-[#FFA500] text-center">Setting</a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-64 p-6 mt-[-80px] space-y-6 h-[calc(100%-6rem)] scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
    <div class="p-6 rounded-lg shadow-2xl">
      <h2 class="text-2xl text-yellow-400 font-bold mb-4">My Portfolio</h2>

      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="text-orange-300 border-b border-gray-700">
            <tr>
              <th class="py-2">#</th>
              <th>Stock</th>
              <th>Quantity</th>
              <th>Avg. Buy Price</th>
              <th>Current Price</th>
              <th>Total Value</th>
              <th>P/L</th>
              <th>Sell</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            {% set symbol = row.stock_symbol %}
            {% set quantity = row.quantity %}
            {% set avg_price = row.avg_buy_price %}
            {% set live_price = prices[symbol] %}
            {% set total_value = quantity * live_price %}
            {% set profit = (live_price - avg_price) * quantity %}
            <tr class="border-t border-gray-800 ">
              <td class="py-2">{{ loop.index }}</td>
              <td class="font-bold text-green-400">{{ symbol }}</td>
              <td>{{ quantity }}</td>
              <td>₹{{ '%.2f' | format(avg_price) }}</td>
              <td>₹{{ '%.2f' | format(live_price) }}</td>
              <td>₹{{ '%.2f' | format(total_value) }}</td>
              <td class="{% if profit >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                ₹{{ '%.2f' | format(profit) }}
              </td>
              <td>
                <form action="/sell/{{ symbol }}" method="POST" class="flex gap-2 items-center">
                  <input type="hidden" name="price" value="{{ '%.2f' | format(live_price) }}">
                  <input
                    type="number"
                    name="quantity"
                    min="1"
                    max="{{ quantity }}"
                    required
                    class="w-16 px-2 py-1 rounded bg-[#2a2a2a] text-white"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    onkeydown="return event.keyCode !== 69 && event.keyCode !== 189 && event.keyCode !== 190;"
                    onblur="if (this.value === '' || this.value < 1) this.value = 1;"
                  >
                  <button type="submit" class="bg-red-500 hover:bg-red-600 text-sm px-3 py-1 rounded">Sell</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center text-gray-400 py-6">You have no stocks in your portfolio yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>
{% endblock %}
