{% extends 'base.html' %}
{% block title %}Market | TradeHaven{% endblock %}

{% block content %}
<div class="pt-24 flex min-h-screen overflow-hidden">

  <!-- Fixed Sidebar -->
  <aside class="w-64 h-[calc(100vh-5rem)] overflow-y-auto shadow-2xl flex flex-col justify-between py-6 px-4 fixed top-20 left-0">
    <div>
      <div class="text-center mb-6 ">
        <div class="text-[#FFA500] font-bold text-xl uppercase">{{ user.name }}</div>
        <div class="mt-3 mb-2 rounded-lg border border-[#FFA500] py-2 px-4 flex items-center justify-center">
          <h6>WALLET : </h6>
          <span class="text-lg font-semibold text-green-400 ps-2"> ₹ {{ '%.2f' | format(user.balance) }}</span>
        </div>
      </div>
      <nav class="space-y-9 text-sm">
        <a href="/dashboard" class="block hover:text-[#FFA500] mt-[50px] text-center">Dashboard</a>
        <a href="/watchlist" class="block hover:text-[#FFA500] text-center">WatchList</a>
        <a href="/portfolio" class="block hover:text-[#FFA500] text-center">Portfolio</a>
        <a href="/market" class="block font-bold text-[#FFA500] text-center">Market</a>
        <a href="/prediction" class="block hover:text-[#FFA500] text-center">Prediction</a>
        <a href="/transactions" class="block hover:text-[#FFA500] text-center">Transaction</a>
        <a href="/support" class="block hover:text-[#FFA500] text-center">Support</a>
        <a href="/settings" class="block hover:text-[#FFA500] text-center">Setting</a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 ml-64 mt-[-80px] p-6 h-[calc(100%-6rem)]">

    <!-- Search bar -->
    <div class="mb-4 flex justify-end">
      <input id="stockSearch" type="text" placeholder="Search stock..."
        class="px-[520px] py-2 w-500 rounded-md border border-gray-600 text-black focus:ring-1 focus:ring-orange-400" />
    </div>

    <div class="p-6 rounded-lg shadow-2xl">
      <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Market</h2>

      <table class="w-full text-sm text-left border-separate border-spacing-y-3">
        <thead class="text-orange-300">
          <tr>
            <th>Symbol</th>
            <th>Price (₹)</th>
            <th>Change (%)</th>
            <th>Chart</th>
            <th>High</th>
            <th>Low</th>
            <th>Sentiment</th>
            <th class="text-center">Buy</th>
            <th class="text-center">Watch</th>
          </tr>
        </thead>
        <tbody>
          {% for stock in stocks %}
          <tr class="transition rounded align-middle">
            <td class="font-bold text-green-400">{{ stock.symbol }}</td>
            <td>₹{{ '%.2f' | format(stock.price) }}</td>
            <td class="{% if stock.change >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
              {{ '%.2f' | format(stock.change) }}%
            </td>
            <td><canvas class="sparkline" id="spark-{{ loop.index0 }}"></canvas></td>
            <td>₹{{ '%.2f' | format(stock.high) }}</td>
            <td>₹{{ '%.2f' | format(stock.low) }}</td>
            <td class="{% if stock.sentiment == 'Bullish' %}text-green-400{% elif stock.sentiment == 'Bearish' %}text-red-400{% else %}text-yellow-400{% endif %}">
              {{ stock.sentiment }}
            </td>

            <!-- Buy Form -->
            <td>
              <form action="/buy/{{ stock.symbol }}" method="POST" class="flex items-center gap-2">
                <input type="hidden" name="price" value="{{ '%.2f' | format(stock.price) }}">
                <input
                  type="number"
                  name="quantity"
                  min="1"
                  required
                  class="w-16 px-2 py-1 rounded bg-[#2a2a2a] text-white text-xs"
                  oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                  onkeydown="return event.keyCode !== 69 && event.keyCode !== 189 && event.keyCode !== 190;"
                  onblur="if (this.value === '' || this.value < 1) this.value = 1;"
                >
                <button type="submit" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 text-xs">
                  Buy
                </button>
              </form>
            </td>

            <!-- Watch Form -->
            <td>
              <form action="/add_watchlist/{{ stock.symbol }}" method="POST">
                <button type="submit" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs">
                  Watch
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- Chart.js & Sparkline Rendering -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const stockData = {{ stocks | tojson }};
  stockData.forEach((stock, index) => {
    const ctx = document.getElementById('spark-' + index).getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: stock.trend.map((_, i) => i + 1),
        datasets: [{
          data: stock.trend,
          borderColor: stock.change >= 0 ? 'lightgreen' : 'red',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
          fill: false,
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { display: false }, y: { display: false } }
      }
    });
  });

  // Stock search filter
  document.getElementById('stockSearch').addEventListener('input', function () {
    const search = this.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(row => {
      const symbol = row.querySelector('td')?.innerText.toLowerCase();
      row.style.display = symbol.includes(search) ? '' : 'none';
    });
  });
</script>
{% endblock %}
